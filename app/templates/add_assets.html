<!DOCTYPE html>
<html>

<head>
    <title>Add Assets</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Add Assets</h2>
        <form id="assetForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Title</label>
                <input type="text" id="title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Image</label>
                <input type="file" id="image" accept="image/*" class="mt-1 block w-full">
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
                Add Asset
            </button>
        </form>
    </div>

    // Update the script section in add_assets.html
    <script>
        document.getElementById('assetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // First upload the file
            const fileInput = document.getElementById('image');
            const file = fileInput.files[0];
            let imagePath = null;

            if (file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const uploadResponse = await fetch('/consultancy/upload-file/', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        imagePath = `/static/uploads/${uploadResult.filename}`;
                    } else {
                        console.error('File upload failed:', await uploadResponse.text());
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    return;
                }
            }

            // Then create the asset
            const assetData = {
                assets: [{
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    image_path: imagePath
                }]
            };

            console.log('Sending asset data:', assetData);

            const requestId = "{{ request_id }}";
            try {
                const response = await fetch(`/consultancy/add_assets/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assetData)
                });

                if (response.ok) {
                    window.location.href = `/consultancy/check-status?id=${requestId}`;
                } else {
                    const errorData = await response.text();
                    console.error('Error response:', errorData);
                    alert('Error adding asset: ' + errorData);
                }
            } catch (error) {
                console.error('Error sending request:', error);
                alert('Error adding asset');
            }
        });
    </script>
</body>

</html>